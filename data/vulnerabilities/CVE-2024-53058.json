{
	"name": "CVE-2024-53058",
	"description": "In the Linux kernel, the following vulnerability has been resolved:net: stmmac: TSO: Fix unbalanced DMA map/unmap for non-paged SKB dataIn case the non-paged data of a SKB carries protocol header and protocolpayload to be transmitted on a certain platform that the DMA AXI addresswidth is configured to 40-bit/48-bit, or the size of the non-paged datais bigger than TSO_MAX_BUFF_SIZE on a certain platform that the DMA AXIaddress width is configured to 32-bit, then this SKB requires at leasttwo DMA transmit descriptors to serve it.For example, three descriptors are allocated to split one DMA buffermapped from one piece of non-paged data:    dma_desc[N + 0],    dma_desc[N + 1],    dma_desc[N + 2].Then three elements of tx_q-\u003etx_skbuff_dma[] will be allocated to holdextra information to be reused in stmmac_tx_clean():    tx_q-\u003etx_skbuff_dma[N + 0],    tx_q-\u003etx_skbuff_dma[N + 1],    tx_q-\u003etx_skbuff_dma[N + 2].Now we focus on tx_q-\u003etx_skbuff_dma[entry].buf, which is the DMA bufferaddress returned by DMA mapping call. stmmac_tx_clean() will try tounmap the DMA buffer _ONLY_IF_ tx_q-\u003etx_skbuff_dma[entry].bufis a valid buffer address.The expected behavior that saves DMA buffer address of this non-pageddata to tx_q-\u003etx_skbuff_dma[entry].buf is:    tx_q-\u003etx_skbuff_dma[N + 0].buf = NULL;    tx_q-\u003etx_skbuff_dma[N + 1].buf = NULL;    tx_q-\u003etx_skbuff_dma[N + 2].buf = dma_map_single();Unfortunately, the current code misbehaves like this:    tx_q-\u003etx_skbuff_dma[N + 0].buf = dma_map_single();    tx_q-\u003etx_skbuff_dma[N + 1].buf = NULL;    tx_q-\u003etx_skbuff_dma[N + 2].buf = NULL;On the stmmac_tx_clean() side, when dma_desc[N + 0] is closed by theDMA engine, tx_q-\u003etx_skbuff_dma[N + 0].buf is a valid buffer addressobviously, then the DMA buffer will be unmapped immediately.There may be a rare case that the DMA engine does not finish thepending dma_desc[N + 1], dma_desc[N + 2] yet. Now things will gohorribly wrong, DMA is going to access a unmapped/unreferenced memoryregion, corrupted data will be transmited or iommu fault will betriggered :(In contrast, the for-loop that maps SKB fragments behaves perfectlyas expected, and that is how the driver should do for both non-pageddata and paged frags actually.This patch corrects DMA map/unmap sequences by fixing the array indexfor tx_q-\u003etx_skbuff_dma[entry].buf when assigning DMA buffer address.Tested and verified on DWXGMAC CORE 3.20a",
	"type": "none",
	"severity": "medium",
	"state": "published",
	"references": [
		"https://git.kernel.org/stable/c/07c9c26e37542486e34d767505e842f48f29c3f6",
		"https://git.kernel.org/stable/c/58d23d835eb498336716cca55b5714191a309286",
		"https://git.kernel.org/stable/c/66600fac7a984dea4ae095411f644770b2561ede",
		"https://git.kernel.org/stable/c/a3ff23f7c3f0e13f718900803e090fd3997d6bc9",
		"https://git.kernel.org/stable/c/ece593fc9c00741b682869d3f3dc584d37b7c9df"
	],
	"datetime": "2024-11-24 00:00:00",
	"connections": [],
	"devices": [],
	"distributions": [
		{
			"name": "debian",
			"version": "bookworm",
			"vendor": "debian-bookworm"
		},
		{
			"name": "debian",
			"version": "bullseye",
			"vendor": "debian-bullseye"
		},
		{
			"name": "debian",
			"version": "sid",
			"vendor": "debian-sid"
		},
		{
			"name": "debian",
			"version": "trixie",
			"vendor": "debian-trixie"
		},
		{
			"name": "cblmariner",
			"version": "2",
			"vendor": "cblmariner-2"
		}
	],
	"packages": [
		{
			"name": "linux",
			"version": "\u003c 0:6.1.119-1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bookworm"
		},
		{
			"name": "linux",
			"version": "any",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bullseye"
		},
		{
			"name": "linux-6.1",
			"version": "\u003c 0:6.1.119-1~deb11u1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bullseye"
		},
		{
			"name": "linux-6.1",
			"version": "\u003c 6.1.119-1~deb11u1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bullseye"
		},
		{
			"name": "linux",
			"version": "\u003c 6.1.119-1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bookworm"
		},
		{
			"name": "linux",
			"version": "\u003c 6.11.7-1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-sid"
		},
		{
			"name": "kernel",
			"version": "\u003c 0:5.15.173.1-1.",
			"architecture": "any",
			"manager": "apt",
			"vendor": "cblmariner-2"
		}
	],
	"products": [
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "\u003c 5.15.171",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "\u003c 6.1.116",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "\u003c 6.6.60",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "\u003c 6.11.7",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.12-rc1",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.12-rc2",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.12-rc3",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.12-rc4",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.12-rc5",
			"type": "system"
		}
	],
	"programs": [],
	"weaknesses": [
		{
			"name": "any",
			"impact": "any",
			"scope": "any"
		}
	]
}