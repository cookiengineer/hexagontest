{
	"name": "CVE-2024-54680",
	"description": "In the Linux kernel, the following vulnerability has been resolved:smb: client: fix TCP timers deadlock after rmmodCommit ef7134c7fc48 (\"smb: client: Fix use-after-free of network namespace.\")fixed a netns UAF by manually enabled socket refcounting(sk-\u003esk_net_refcnt=1 and sock_inuse_add(net, 1)).The reason the patch worked for that bug was because we now holdreferences to the netns (get_net_track() gets a ref internally)and they're properly released (internally, on __sk_destruct()),but only because sk-\u003esk_net_refcnt was set.Problem:(this happens regardless of CONFIG_NET_NS_REFCNT_TRACKER and regardlessif init_net or other)Setting sk-\u003esk_net_refcnt=1 *manually* and *after* socket creation is notonly out of cifs scope, but also technically wrong -- it's set conditionallybased on user (=1) vs kernel (=0) sockets.  And net/ implementationsseem to base their user vs kernel space operations on it.e.g. upon TCP socket close, the TCP timers are not cleared becausesk-\u003esk_net_refcnt=1:(cf. commit 151c9c724d05 (\"tcp: properly terminate timers for kernel sockets\"))net/ipv4/tcp.c:    void tcp_close(struct sock *sk, long timeout)    {        lock_sock(sk);        __tcp_close(sk, timeout);        release_sock(sk);        if (!sk-\u003esk_net_refcnt)            inet_csk_clear_xmit_timers_sync(sk);        sock_put(sk);    }Which will throw a lockdep warning and then, as expected, deadlock ontcp_write_timer().A way to reproduce this is by running the reproducer from ef7134c7fc48and then 'rmmod cifs'.  A few seconds later, the deadlock/lockdepwarning shows up.Fix:We shouldn't mess with socket internals ourselves, so do not setsk_net_refcnt manually.Also change __sock_create() to sock_create_kern() for explicitness.As for non-init_net network namespaces, we deal with it the best waywe can -- hold an extra netns reference for server-\u003essocket and drop itwhen it's released.  This ensures that the netns still exists wheneverwe need to create/destroy server-\u003essocket, but is not directly tied toit.",
	"type": "none",
	"severity": "none",
	"state": "published",
	"references": [
		"https://git.kernel.org/stable/c/127e907e11ccd54b59bb78fc22c43ccb76c71079",
		"https://git.kernel.org/stable/c/906807c734ed219dcb2e7bbfde5c4168ed72a3d0",
		"https://git.kernel.org/stable/c/e9f2517a3e18a54a3943c098d2226b245d488801"
	],
	"datetime": "2025-02-06 12:35:28",
	"connections": [],
	"devices": [],
	"distributions": [
		{
			"name": "debian",
			"version": "bookworm",
			"vendor": "debian-bookworm"
		},
		{
			"name": "debian",
			"version": "bullseye",
			"vendor": "debian-bullseye"
		},
		{
			"name": "debian",
			"version": "sid",
			"vendor": "debian-sid"
		},
		{
			"name": "debian",
			"version": "trixie",
			"vendor": "debian-trixie"
		}
	],
	"packages": [
		{
			"name": "linux",
			"version": "\u003c 6.1.123-1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bookworm"
		},
		{
			"name": "linux",
			"version": "\u003c 5.10.223-1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-bullseye"
		},
		{
			"name": "linux",
			"version": "\u003c 6.12.8-1",
			"architecture": "any",
			"manager": "apt",
			"vendor": "debian-sid"
		}
	],
	"products": [
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "\u003c 6.6.68",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "\u003c 6.12.7",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.13-rc1",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.13-rc2",
			"type": "system"
		},
		{
			"name": "linux:linux-kernel",
			"vendor": "linux",
			"product": "linux-kernel",
			"version": "6.13-rc3",
			"type": "system"
		}
	],
	"programs": [],
	"weaknesses": [
		{
			"name": "CWE-667",
			"impact": "any",
			"scope": "any"
		}
	]
}